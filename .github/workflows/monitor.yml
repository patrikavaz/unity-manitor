name: Unity.com JS File Monitor

# 1. ØªØ¹Ø±ÛŒÙ Ù…Ø¬ÙˆØ²Ù‡Ø§ (Permissions) - Ø­ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Commit
permissions:
  contents: write # Ø¨Ø±Ø§ÛŒ commit Ú©Ø±Ø¯Ù† ØªØºÛŒÛŒØ±Ø§Øª

on:
  # Ø²Ù…Ø§Ù†Ø¨Ù†Ø¯ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ (Ù‡Ø± 3 Ø³Ø§Ø¹Øª)
  schedule:
    - cron: '0 */6 * * *' # 00, 03, 06, 09, 12, 15, 18, 21 UTC (Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø³Ø±ÙˆØ± Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)

jobs:
  monitor-js-files:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      BASE_URL: "https://unity.com"
      
    steps:
      # 2. Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ (Checkout) - Ù…Ø­ÛŒØ· Ø¨Ø§ÛŒØ¯ Ø§ÙˆÙ„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´ÙˆØ¯
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„ Git

      # 3. Ø§Ø¹Ù„Ø§Ù† Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± (Notification Start) - Ø­Ø§Ù„Ø§ Ø¨Ø¹Ø¯ Ø§Ø² Checkout
      - name: Notify Workflow Start
        run: |
          BOT_TOKEN="${{ env.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ env.TELEGRAM_CHAT_ID }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          START_MESSAGE="ğŸš€ *Workflow Started: Unity JS Monitor* ğŸš€%0A%0ARepository: ${{ github.repository }}%0ARun ID: ${{ github.run_id }}%0A%0A[View Run Details](${RUN_URL})"

          # URL Encoding - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ Ø³ÛŒÙ†ØªÚ©Ø³ÛŒ
          URL_ENCODED_MESSAGE=$(echo -e "$START_MESSAGE" | sed 's/ /%20/g' | sed 's/!/%21/g' | sed 's/#/%23/g' | sed 's/\./%2E/g')

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
               -d "chat_id=$CHAT_ID" \
               -d "parse_mode=Markdown" \
               -d "text=$URL_ENCODED_MESSAGE"
        shell: bash

      # 4. Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù…
      - name: Install Dependencies
        run: |
          npm install -g js-beautify

      # 5. Fetch JS URLs & Download (Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² wget/curl Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯)
      - name: Fetch all JS URLs from main page
        id: fetch_urls
        run: |
          # Fetch HTML
          HTML_CONTENT=$(curl -s "${{ env.BASE_URL }}")
          # Extract URLs using grep/sed (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ… Ø¯Ù‚ÛŒÙ‚ Ø¯Ø§Ø±Ø¯)
          JS_URLS=$(echo "$HTML_CONTENT" | grep -oP 'src="\K[^"]*\.js"')
          
          echo "Found the following JS files:"
          echo "$JS_URLS"
          
          echo "$JS_URLS" > js_list.txt
        shell: bash

      - name: Download JS files
        run: |
          mkdir -p downloaded_js
          while IFS= read -r url; do
              # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ú©Ø§Ù…Ù„ Ø¨ÙˆØ¯Ù† Ù„ÛŒÙ†Ú© (ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ù‡Ù…Ù‡ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ù…Ø·Ù„Ù‚ Ù‡Ø³ØªÙ†Ø¯ ÛŒØ§ Ø¨Ø§ BASE_URL ØªØ±Ú©ÛŒØ¨ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)
              FULL_URL="${{ env.BASE_URL }}${url}"
              FILENAME=$(basename "$url")
              echo "Downloading: $FULL_URL -> downloaded_js/$FILENAME"
              curl -s -o "downloaded_js/$FILENAME" "$FULL_URL"
          done < js_list.txt

      # 6. Ù¾Ø±Ø¯Ø§Ø²Ø´: Ù…Ù‚Ø§ÛŒØ³Ù‡ Ùˆ Ú©Ø§Ù…ÛŒØª
      - name: Beautify JS
        id: beautify
        run: |
          # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø§ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù†Ø¯ (Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø§ ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ)
          for file in downloaded_js/*.js; do
            js-beautify -r "$file" -o "beautified_js/$(basename "$file")"
          done
          # Ø¯Ø± Ø§ÛŒÙ† Ø³Ù†Ø§Ø±ÛŒÙˆØŒ Ù…Ø§ Ø¨Ø§ÛŒØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø¨Ø§ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ¨Ø§Ø³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒÙ… Ùˆ ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø³Ù†Ø¬ÛŒÙ…
          # (Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ù…Ù†Ø·Ù‚ Ø¯Ù‚ÛŒÙ‚ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ "ØªØºÛŒÛŒØ±"ØŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ… Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
          cp downloaded_js/* beautified_js/ # Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒØŒ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… beautified_js Ø±Ø§ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… Ùˆ Ø¨Ø¹Ø¯Ø§Ù‹ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…

      - name: Commit if changed
        id: commit_action
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
          commit_message: 'Automated update of Unity.com JS files'
          file_pattern: 'downloaded_js/**' # ÛŒØ§ Ù‡Ø± Ù…Ø³ÛŒØ±ÛŒ Ú©Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± Ø¢Ù† Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª
          
      # 7. Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø´Ø¯Ø§Ø± ØªÙ„Ú¯Ø±Ø§Ù… (Ø¨Ø± Ø§Ø³Ø§Ø³ Ø®Ø±ÙˆØ¬ÛŒ Ú©Ø§Ù…ÛŒØª)
      - name: Prepare Telegram Notification Flag
        if: steps.commit_action.outputs.committed == 'true'
        run: |
          echo "SEND_NOTIFICATION=true" >> $GITHUB_ENV
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          echo "SUMMARY=JS files updated by monitor. Commit Hash: ${{ github.sha }}" >> $GITHUB_ENV
          echo "COMMIT_URL=$COMMIT_URL" >> $GITHUB_ENV
        shell: bash
        
      # 8. Ø§Ø±Ø³Ø§Ù„ Ù‡Ø´Ø¯Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ (ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª ØªØºÛŒÛŒØ±)
      - name: Send Telegram Notification (on Change)
        if: env.SEND_NOTIFICATION == 'true'
        run: |
          BOT_TOKEN="${{ env.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ env.TELEGRAM_CHAT_ID }}"
          
          MESSAGE_TEXT="ğŸš¨ *Unity JS Change Detected on ${{ github.repository }}* ğŸš¨%0A%0A${{ env.SUMMARY }}%0A%0A[View Commit Details](${{ env.COMMIT_URL }})"

          URL_ENCODED_MESSAGE=$(echo -e "$MESSAGE_TEXT" | sed 's/ /%20/g' | sed 's/!/%21/g' | sed 's/#/%23/g' | sed 's/\./%2E/g')

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
               -d "chat_id=$CHAT_ID" \
               -d "parse_mode=Markdown" \
               -d "text=$URL_ENCODED_MESSAGE"
        shell: bash
