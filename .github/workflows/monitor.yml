name: Unity.com JS File Monitor

permissions:
  contents: write

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  monitor-js-files:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      BASE_URL: "https://unity.com"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Notify Workflow Start
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          MESSAGE=$(cat <<EOF
          ğŸš€ *Workflow Started: Unity JS Monitor*

          Repository: \`${{ github.repository }}\`
          Run ID: \`${{ github.run_id }}\`

          [View Run Details](${RUN_URL})
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
               -H "Content-Type: application/json" \
               -d "$(jq -n \
                    --arg chat_id "$TELEGRAM_CHAT_ID" \
                    --arg text "$MESSAGE" \
                    '{chat_id: $chat_id, text: $text, parse_mode: "Markdown"}')"
        shell: bash

      - name: Install Dependencies
        run: npm install -g js-beautify

      - name: Fetch all JS URLs from main page
        id: fetch_urls
        run: |
          HTML_CONTENT=$(curl -s "${BASE_URL}")
          JS_URLS=$(echo "$HTML_CONTENT" | grep -oP 'src="\K[^"]+\.js' || true)

          if [ -z "$JS_URLS" ]; then
            echo "âš ï¸ No JS files found!"
            echo "js_found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found JS files:"
          echo "$JS_URLS"
          echo "$JS_URLS" > js_list.txt
          echo "js_found=true" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Download JS files
        if: steps.fetch_urls.outputs.js_found == 'true'
        run: |
          mkdir -p downloaded_js

          while IFS= read -r url; do
            if [[ "$url" == http* ]]; then
              FULL_URL="$url"
            elif [[ "$url" == //* ]]; then
              FULL_URL="https:${url}"
            elif [[ "$url" == /* ]]; then
              FULL_URL="${BASE_URL}${url}"
            else
              FULL_URL="${BASE_URL}/${url}"
            fi

            FILENAME=$(echo "$url" | sed 's|.*/||' | sed 's/[?&=]/_/g')
            [ -z "$FILENAME" ] && FILENAME="unknown_$(date +%s%N).js"

            echo "Downloading: $FULL_URL -> downloaded_js/$FILENAME"
            curl -sL -o "downloaded_js/$FILENAME" "$FULL_URL" || echo "âš ï¸ Failed: $FULL_URL"
          done < js_list.txt
        shell: bash

      - name: Beautify JS files
        if: steps.fetch_urls.outputs.js_found == 'true'
        run: |
          for file in downloaded_js/*.js; do
            [ -f "$file" ] && js-beautify -r "$file" || true
          done
        shell: bash

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # âœ… FIX: Use GITHUB_OUTPUT instead of GITHUB_ENV for conditionals
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check for changes and Commit
        id: commit_step
        run: |
          git add downloaded_js/

          if git diff --cached --quiet; then
            echo "No changes detected."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected!"
            
            # Configure git
            git config user.name "GitHub Actions Bot"
            git config user.email "actions@github.com"
            
            # Commit
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
            git commit -m "Automated update of Unity.com JS files - ${TIMESTAMP}"
            git push
            
            # Get the new commit SHA
            NEW_SHA=$(git rev-parse HEAD)
            COMMIT_URL="https://github.com/${{ github.repository }}/commit/${NEW_SHA}"
            
            # Save to outputs (NOT env)
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "commit_sha=${NEW_SHA}" >> "$GITHUB_OUTPUT"
            echo "commit_url=${COMMIT_URL}" >> "$GITHUB_OUTPUT"
            
            # Get changed files list
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | head -20)
            
            # Multi-line output handling
            {
              echo "changed_files<<EOF"
              echo "$CHANGED_FILES"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi
        shell: bash

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # âœ… FIX: Access via steps.<id>.outputs.<name>
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Send Telegram Notification (on Change)
        if: steps.commit_step.outputs.has_changes == 'true'
        run: |
          COMMIT_SHA="${{ steps.commit_step.outputs.commit_sha }}"
          COMMIT_URL="${{ steps.commit_step.outputs.commit_url }}"
          CHANGED_FILES="${{ steps.commit_step.outputs.changed_files }}"

          MESSAGE=$(cat <<EOF
          ğŸš¨ *Unity JS Change Detected!*

          ğŸ“¦ Repository: \`${{ github.repository }}\`
          ğŸ”— Commit: \`${COMMIT_SHA}\`

          ğŸ“ *Changed Files:*
          \`\`\`
          ${CHANGED_FILES}
          \`\`\`

          [View Commit Details](${COMMIT_URL})
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
               -H "Content-Type: application/json" \
               -d "$(jq -n \
                    --arg chat_id "$TELEGRAM_CHAT_ID" \
                    --arg text "$MESSAGE" \
                    '{chat_id: $chat_id, text: $text, parse_mode: "Markdown"}')"
        shell: bash

      - name: No Changes Notification
        if: steps.commit_step.outputs.has_changes == 'false'
        run: |
          MESSAGE="â„¹ï¸ *Unity JS Monitor*: No changes detected."
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
               -H "Content-Type: application/json" \
               -d "$(jq -n \
                    --arg chat_id "$TELEGRAM_CHAT_ID" \
                    --arg text "$MESSAGE" \
                    '{chat_id: $chat_id, text: $text, parse_mode: "Markdown"}')"
        shell: bash

      - name: Send Completion Status
        if: always()
        run: |
          STATUS="${{ job.status }}"
          [ "$STATUS" = "success" ] && EMOJI="âœ…" || EMOJI="âŒ"

          MESSAGE="${EMOJI} *Workflow Completed*: ${STATUS}"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
               -H "Content-Type: application/json" \
               -d "$(jq -n \
                    --arg chat_id "$TELEGRAM_CHAT_ID" \
                    --arg text "$MESSAGE" \
                    '{chat_id: $chat_id, text: $text, parse_mode: "Markdown"}')"
        shell: bash
