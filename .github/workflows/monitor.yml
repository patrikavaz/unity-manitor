name: Monitor Unity Cloud JS Changes (with Cleanup & Alert)

on:
  schedule:
    - cron: '0 */3 * * *' # Ø§Ø¬Ø±Ø§ Ù‡Ø± 3 Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø±
  workflow_dispatch: # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

permissions:
  contents: write # Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ commit Ú©Ø±Ø¯Ù† ØªØºÛŒÛŒØ±Ø§Øª

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      # >>> Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø¯ÛŒØ¯: Ø§Ø¹Ù„Ø§Ù… Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± <<<
      - name: Notify Workflow Start
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # URL Encoding for Markdown safety
          URL_ENCODED_MESSAGE=$(echo -e "ğŸš€ *Workflow Started: Unity JS Monitor* ğŸš€%0A%0ARepository: ${{ github.repository }}%0ARun ID: ${{ github.run_id }}%0A%0A[View Run Details](${RUN_URL})" | sed 's/ /%20/g' | sed 's/!/%21/g' | sed 's/#/%23/g' | sed 's/\./%2E/g')

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
               -d "chat_id=$CHAT_ID" \
               -d "parse_mode=Markdown" \
               -d "text=$URL_ENCODED_MESSAGE"
        shell: bash
      # >>> Ù¾Ø§ÛŒØ§Ù† Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø¯ÛŒØ¯ <<<

      # 1. Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø­ÛŒØ·
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ ÙØ¶Ø§ÛŒ Ú©Ø§Ø±ÛŒ (Cleanup Strategy)
      - name: Clean old files
        run: rm -rf chunks && mkdir -p chunks
        # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ù¾ÙˆØ´Ù‡ chunks Ù‚Ø¨Ù„ Ø§Ø² Ø¯Ø§Ù†Ù„ÙˆØ¯ØŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.

      - name: Prepare folders
        run: mkdir -p chunks

      # 3. ÙˆØ§Ú©Ø´ÛŒ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯
      - name: Fetch all JS URLs from main page
        id: fetch_js
        run: |
          # Fetching unique JS file URLs and saving them to a file
          curl -s https://unity.com | grep -o '/_next/static[^"]*\.js' | sort -u > js_list.txt

      - name: Download JS files
        run: |
          while read file; do
            url="https://unity.com${file}"
            out="chunks${file}"
            mkdir -p "$(dirname "$out")"
            # Using -f (fail fast) and -L (follow redirects) for robust download
            curl -f -L "$url" -o "$out"
          done < js_list.txt

      # 4. Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ Ø®ÙˆØ§Ù†Ø§Ø³Ø§Ø²ÛŒ
      - name: Beautify JS
        run: |
          npm install -g js-beautify
          # Formatting all .js files in the chunks directory for better diff readability
          find chunks -name "*.js" -exec js-beautify -r {} \;

      # 5. Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± Git
      - name: Commit if changed
        id: commit_action
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated update of Unity.com JS files"
          file_pattern: chunks
          
      # 6. Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø´Ø¯Ø§Ø± ØªÙ„Ú¯Ø±Ø§Ù…
      - name: Prepare Telegram Notification Flag
        if: steps.commit_action.outputs.committed == 'true' # Only proceed if a commit was actually made
        run: |
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$LAST_COMMIT_MSG" == "Automated update of Unity.com JS files"* ]]; then
            echo "SEND_NOTIFICATION=true" >> $GITHUB_ENV
            echo "SUMMARY=JS files updated. New commit hash: ${{ github.sha }}" >> $GITHUB_ENV
          else
            echo "SEND_NOTIFICATION=false" >> $GITHUB_ENV
          fi
        shell: bash

      # 7. Ø§Ø±Ø³Ø§Ù„ Ù‡Ø´Ø¯Ø§Ø± Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… (ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª ØªØºÛŒÛŒØ±)
      - name: Send Telegram Notification (on Change)
        if: env.SEND_NOTIFICATION == 'true'
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          URL_ENCODED_MESSAGE=$(echo -e "ğŸš¨ *Unity JS Change Detected on ${{ github.repository }}* ğŸš¨%0A%0A${{ env.SUMMARY }}%0A%0A[View Commit Details](${{"https://github.com/${{ github.repository }}/commit/${{ github.sha }}"}})" | sed 's/ /%20/g' | sed 's/!/%21/g' | sed 's/#/%23/g' | sed 's/\./%2E/g')

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
               -d "chat_id=$CHAT_ID" \
               -d "parse_mode=Markdown" \
               -d "text=$URL_ENCODED_MESSAGE"
        shell: bash
